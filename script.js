// ========== LANGUAGE TRANSLATIONS ==========
const translations = {
    en: {
        'nav-home': 'Home',
        'nav-mapping': 'Mapping',
        'nav-disaster': 'Disaster Alert',
        'nav-emergency': 'Emergency',
        'nav-about': 'About Us',
        'hero-title': 'HazardGuard',
        'hero-subtitle': 'HazardGuard is a disaster awareness and preparedness website that helps people learn about natural hazards like earthquakes, floods, and landslides in Nepal and provides real‑time alerts and emergency contact information to stay safe.',
        'discover-btn': 'Discover',
        'home-title': 'Understanding Disaster Risks in Nepal',
        'home-text1': 'Natural disasters in Nepal occur unexpectedly and can cause severe damage to communities. The country\'s diverse geography makes it vulnerable to various hazards that threaten lives and property. Early warning systems and public awareness are crucial for reducing disaster risks. Timely alerts allow communities to prepare, evacuate if necessary, and minimize casualties.',
        'checklist-title': 'Quick Preparedness Checklist',
        'check1-label': 'Create a family emergency plan with meeting points',
        'check2-label': 'Prepare a 3-day emergency supply kit',
        'check3-label': 'Know your nearest emergency shelter location',
        'mapping-title': 'Nepal Disaster & Environmental Risk Visualization',
        'mapping-text': 'Visual representation of disaster-prone areas across Nepal. Select different layers to see specific risk types. Click on any location marker to see its weather information.',
        'weather-humidity-label': 'Humidity',
        'weather-wind-label': 'Wind Speed',
        'weather-feels-label': 'Feels Like',
        'map-title': 'Interactive Risk Map',
        'map-all': 'All Risks',
        'map-earthquake': 'Earthquakes',
        'map-flood': 'Flood Risk',
        'map-landslide': 'Landslides',
        'legend-title': 'Risk Level Legend',
        'legend-high': 'High Risk',
        'legend-medium': 'Medium Risk',
        'legend-low': 'Low Risk',
        'alert-title': 'Real-time Disaster Alert System',
        'alert-text': 'Get real-time alerts and environmental data for your selected district. Click on any alert card to see specific preparedness actions.',
        'location-status': 'Select your district or use your current location',
        'use-location': 'Use My Location',
        'see-other': 'Wanna see other?',
        'select-district': '-- Select Your District --',
        'get-alerts': 'Get Alerts',
        'air-title': 'Air Quality',
        'status-label': 'Status',
        'pm-label': 'PM2.5',
        'location-label': 'Location',
        'updated-label': 'Updated',
        'flood-title': 'Flood Alert',
        'flood-status-label': 'Status',
        'river-label': 'River',
        'danger-label': 'Danger Level',
        'flood-updated-label': 'Updated',
        'refresh-text': 'Refresh Real-time Data',
        'emergency-title': 'Emergency Contacts',
        'emergency-subtitle': 'Click any number to call immediately from your device.',
        'police-title': 'Police',
        'police-desc': 'Emergency response & law enforcement',
        'police-detail': 'For crimes, accidents, and immediate police assistance.',
        'fire-title': 'Fire Department',
        'fire-desc': 'Fire emergencies & rescue operations',
        'fire-detail': 'For fire incidents, gas leaks, building collapses, and rescues.',
        'ambulance-title': 'Ambulance',
        'ambulance-desc': 'Medical emergencies & patient transport',
        'ambulance-detail': 'For medical emergencies, accidents, and health crises.',
        'disaster-title': 'Disaster Helpline',
        'disaster-desc': 'Natural disaster emergencies',
        'disaster-detail': 'For earthquake, flood, landslide reports and coordination.',
        'about-title': 'About Us',
        'about-text': 'HazardGuard is developed by a dedicated team of students passionate about disaster awareness and community safety in Nepal.',
        'samrat-role': 'Lead Developer',
        'samrat-desc': 'Lead programmer and architect behind HazardGuard\'s functionality and data systems.',
        'aayushman-role': 'UI/UX Designer',
        'aayushman-desc': 'Designed the user interface and experience to ensure intuitive navigation and accessibility.',
        'chatbot-title': 'HazardGuard AI',
        'chatbot-welcome': 'Hi! I\'m your AI assistant. Ask me anything about disasters, weather, or any district in Nepal.',
        'chatbot-input-placeholder': 'Type your question...',
        'footer-title': 'HazardGuard Nepal',
        'footer-text': 'A disaster awareness and preparedness platform designed to enhance community safety through education, real-time information, and emergency resources.',
        'footer-copyright': '© 2024 HazardGuard | Educational Project | Real-time data from OpenWeatherMap, IQAir, USGS'
    },
    np: {
        'nav-home': 'गृहपृष्ठ',
        'nav-mapping': 'नक्सांकन',
        'nav-disaster': 'प्रकोप चेतावनी',
        'nav-emergency': 'आपतकालीन',
        'nav-about': 'हाम्रो बारेमा',
        'hero-title': 'हजार्डगार्ड',
        'hero-subtitle': 'हजार्डगार्ड एक प्रकोप जागरूकता र तयारी वेबसाइट हो जसले मानिसहरूलाई नेपालमा भूकम्प, बाढी र पहिरो जस्ता प्राकृतिक प्रकोपहरूको बारेमा जान्न मद्दत गर्दछ र सुरक्षित रहन वास्तविक-समय चेतावनी र आपतकालीन सम्पर्क जानकारी प्रदान गर्दछ।',
        'discover-btn': 'पत्ता लगाउनुहोस्',
        'home-title': 'नेपालमा प्रकोप जोखिम बुझ्दै',
        'home-text1': 'नेपालमा प्राकृतिक प्रकोप अप्रत्याशित रूपमा हुन्छन् र समुदायहरूलाई गम्भीर क्षति पुर्याउन सक्छन्। देशको विविध भौगोलिक अवस्थाले यसलाई विभिन्न खतराहरूको लागि संवेदनशील बनाउँछ जसले जीवन र सम्पत्तिलाई खतरामा पार्छ। प्रारम्भिक चेतावनी प्रणाली र सार्वजनिक जागरूकता प्रकोप जोखिम कम गर्नको लागि महत्वपूर्ण छन्। समयमै चेतावनीले समुदायहरूलाई तयारी गर्न, आवश्यक परेमा खाली गर्न र हताहती कम गर्न अनुमति दिन्छ।',
        'checklist-title': 'द्रुत तयारी चेकलिस्ट',
        'check1-label': 'बैठक बिन्दुहरू सहित परिवार आपतकालीन योजना बनाउनुहोस्',
        'check2-label': '३-दिने आपतकालीन आपूर्ति किट तयार गर्नुहोस्',
        'check3-label': 'आफ्नो नजिकको आपतकालीन आश्रय स्थान थाहा पाउनुहोस्',
        'mapping-title': 'नेपाल प्रकोप र वातावरणीय जोखिम भिजुअलाइजेसन',
        'mapping-text': 'नेपाल भर प्रकोप-प्रवण क्षेत्रहरूको दृश्य प्रतिनिधित्व। विशिष्ट जोखिम प्रकारहरू हेर्न विभिन्न तहहरू चयन गर्नुहोस्। यसको मौसम जानकारी हेर्न कुनै पनि स्थान मार्करमा क्लिक गर्नुहोस्।',
        'weather-humidity-label': 'आर्द्रता',
        'weather-wind-label': 'हावाको गति',
        'weather-feels-label': 'जस्तो लाग्छ',
        'map-title': 'अन्तरक्रियात्मक जोखिम नक्सा',
        'map-all': 'सबै जोखिम',
        'map-earthquake': 'भूकम्प',
        'map-flood': 'बाढी जोखिम',
        'map-landslide': 'पहिरो',
        'legend-title': 'जोखिम स्तर व्याख्या',
        'legend-high': 'उच्च जोखिम',
        'legend-medium': 'मध्यम जोखिम',
        'legend-low': 'कम जोखिम',
        'alert-title': 'वास्तविक-समय प्रकोप चेतावनी प्रणाली',
        'alert-text': 'तपाईंको चयन गरिएको जिल्लाको लागि वास्तविक-समय चेतावनी र वातावरणीय डाटा प्राप्त गर्नुहोस्। विशिष्ट तयारी कार्यहरू हेर्न कुनै पनि चेतावनी कार्डमा क्लिक गर्नुहोस्।',
        'location-status': 'तपाईंको जिल्ला चयन गर्नुहोस् वा तपाईंको हालको स्थान प्रयोग गर्नुहोस्',
        'use-location': 'मेरो स्थान प्रयोग गर्नुहोस्',
        'see-other': 'अरू हेर्न चाहनुहुन्छ?',
        'select-district': '-- तपाईंको जिल्ला चयन गर्नुहोस् --',
        'get-alerts': 'चेतावनी प्राप्त गर्नुहोस्',
        'air-title': 'वायु गुणस्तर',
        'status-label': 'स्थिति',
        'pm-label': 'PM2.5',
        'location-label': 'स्थान',
        'updated-label': 'अद्यावधिक',
        'flood-title': 'बाढी चेतावनी',
        'flood-status-label': 'स्थिति',
        'river-label': 'नदी',
        'danger-label': 'खतरा स्तर',
        'flood-updated-label': 'अद्यावधिक',
        'refresh-text': 'वास्तविक-समय डाटा ताजा गर्नुहोस्',
        'emergency-title': 'आपतकालीन सम्पर्कहरू',
        'emergency-subtitle': 'तपाईंको उपकरणबाट तुरुन्तै कल गर्न कुनै पनि नम्बरमा क्लिक गर्नुहोस्।',
        'police-title': 'प्रहरी',
        'police-desc': 'आपतकालीन प्रतिक्रिया र कानून प्रवर्तन',
        'police-detail': 'अपराध, दुर्घटना र तत्काल प्रहरी सहायताको लागि।',
        'fire-title': 'दमकल विभाग',
        'fire-desc': 'आगो आपतकालीन र उद्धार कार्य',
        'fire-detail': 'आगो घटना, ग्यास चुहावट, भवन भत्किएको र उद्धारको लागि।',
        'ambulance-title': 'एम्बुलेन्स',
        'ambulance-desc': 'चिकित्सा आपतकालीन र बिरामी ढुवानी',
        'ambulance-detail': 'चिकित्सा आपतकालीन, दुर्घटना र स्वास्थ्य संकटको लागि।',
        'disaster-title': 'प्रकोप हेल्पलाइन',
        'disaster-desc': 'प्राकृतिक प्रकोप आपतकालीन',
        'disaster-detail': 'भूकम्प, बाढी, पहिरो रिपोर्ट र समन्वयको लागि।',
        'about-title': 'हाम्रो बारेमा',
        'about-text': 'हजार्डगार्ड नेपालमा प्रकोप जागरूकता र सामुदायिक सुरक्षाको बारेमा भावुक विद्यार्थीहरूको समर्पित टोलीद्वारा विकसित गरिएको हो।',
        'samrat-role': 'प्रमुख विकासकर्ता',
        'samrat-desc': 'हजार्डगार्डको कार्यक्षमता र डाटा प्रणाली पछाडि प्रमुख प्रोग्रामर र आर्किटेक्ट।',
        'aayushman-role': 'UI/UX डिजाइनर',
        'aayushman-desc': 'सहज नेभिगेसन र पहुँच सुनिश्चित गर्न प्रयोगकर्ता इन्टरफेस र अनुभव डिजाइन गरे।',
        'chatbot-title': 'हजार्डगार्ड एआई',
        'chatbot-welcome': 'नमस्ते! म तपाईंको एआई सहायक हुँ। मलाई प्रकोप, मौसम वा नेपालको कुनै पनि जिल्लाको बारेमा सोध्नुहोस्।',
        'chatbot-input-placeholder': 'तपाईंको प्रश्न टाइप गर्नुहोस्...',
        'footer-title': 'हजार्डगार्ड नेपाल',
        'footer-text': 'शिक्षा, वास्तविक-समय जानकारी र आपतकालीन स्रोतहरू मार्फत सामुदायिक सुरक्षा बढाउन डिजाइन गरिएको प्रकोप जागरूकता र तयारी प्लेटफर्म।',
        'footer-copyright': '© २०२४ हजार्डगार्ड | शैक्षिक परियोजना | वास्तविक-समय डाटा OpenWeatherMap, IQAir, USGS बाट'
    }
};

// ========== LANGUAGE TOGGLE FUNCTION ==========
function setLanguage(lang) {
    const elements = document.querySelectorAll('[id]');
    elements.forEach(el => {
        const id = el.id;
        if (translations[lang] && translations[lang][id]) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = translations[lang][id];
            } else if (el.tagName === 'OPTION') {
                el.textContent = translations[lang][id];
            } else {
                el.innerHTML = translations[lang][id];
            }
        }
    });
    
    // Update active language label
    document.getElementById('lang-en').classList.toggle('active', lang === 'en');
    document.getElementById('lang-np').classList.toggle('active', lang === 'np');
}

// Initialize language toggle
document.addEventListener('DOMContentLoaded', () => {
    const langSwitch = document.getElementById('lang-switch');
    
    // Set initial language (English)
    setLanguage('en');
    
    // Add event listener
    langSwitch.addEventListener('change', (e) => {
        const lang = e.target.checked ? 'np' : 'en';
        setLanguage(lang);
    });
});

// ========== API KEYS ==========
const WEATHER_API_KEY = 'b0b72746fb74ffb6a3040761cbee2db7';
const AIR_QUALITY_API_KEY = 'd8bb3306-d1a6-4700-9baa-853f5b773af1';
const FLOOD_API_KEY = '55b6f1a6-627d-4876-abc1-8c25553643de';
const EARTHQUAKE_API_KEY = 'A7P79EnubyYXLwz2eCMAnSSH9TJbi7EsMndMLkrJ';
const OPENAI_API_KEY = xxxxxxx
const CORS_PROXY = 'https://corsproxy.io/?';

let currentDistrict = 'Kathmandu';
let map = null;

// District risk data (simplified for demo – expand as needed)
const districtRiskData = {
    'kathmandu': { earthquake: 'high', flood: 'low', landslide: 'medium' },
    'bhaktapur': { earthquake: 'high', flood: 'low', landslide: 'medium' },
    'lalitpur': { earthquake: 'high', flood: 'low', landslide: 'medium' },
    'pokhara': { earthquake: 'medium', flood: 'low', landslide: 'high' },
    'biratnagar': { earthquake: 'low', flood: 'high', landslide: 'low' },
    'default': { earthquake: 'medium', flood: 'medium', landslide: 'medium' }
};

const preparednessData = {
    earthquake: {
        high: { title: 'Earthquake Alert - High Risk', icon: 'fas fa-bolt', alertTitle: 'Immediate Action Required', description: 'Major seismic activity possible.', riskLevel: 'HIGH RISK', riskColor: '#ef4444', preparedness: ['Drop, Cover, and Hold On', 'Secure heavy furniture', 'Prepare go-bag'], note: 'During shaking: Drop to hands and knees, Cover head.' },
        medium: { title: 'Earthquake Alert - Medium Risk', icon: 'fas fa-bolt', alertTitle: 'Stay Prepared', description: 'Moderate earthquake risk.', riskLevel: 'MEDIUM RISK', riskColor: '#f59e0b', preparedness: ['Prepare emergency kit', 'Secure tall furniture'], note: 'Check your home for hazards.' },
        low: { title: 'Earthquake Alert - Low Risk', icon: 'fas fa-bolt', alertTitle: 'Basic Preparedness', description: 'Low earthquake risk.', riskLevel: 'LOW RISK', riskColor: '#10b981', preparedness: ['Keep basic supplies', 'Learn first aid'], note: 'Earthquakes can occur anywhere.' }
    },
    flood: {
        high: { title: 'Flood Alert - High Risk', icon: 'fas fa-water', alertTitle: 'Immediate Evacuation', description: 'River levels above danger.', riskLevel: 'HIGH RISK', riskColor: '#ef4444', preparedness: ['Move to higher ground', 'Turn off utilities'], note: 'Never walk through flood water.' },
        medium: { title: 'Flood Alert - Medium Risk', icon: 'fas fa-water', alertTitle: 'Prepare for Flooding', description: 'Moderate flood risk.', riskLevel: 'MEDIUM RISK', riskColor: '#f59e0b', preparedness: ['Prepare sandbags', 'Clear drains'], note: 'Monitor river levels.' },
        low: { title: 'Flood Alert - Low Risk', icon: 'fas fa-water', alertTitle: 'Monitor Conditions', description: 'Low flood risk.', riskLevel: 'LOW RISK', riskColor: '#10b981', preparedness: ['Keep drainage clear', 'Know evacuation routes'], note: 'Flash floods possible.' }
    },
    landslide: {
        high: { title: 'Landslide Alert - High Risk', icon: 'fas fa-layer-group', alertTitle: 'Extreme Danger', description: 'Extreme risk of landslides.', riskLevel: 'HIGH RISK', riskColor: '#ef4444', preparedness: ['Evacuate hillsides', 'Listen for unusual sounds'], note: 'Move diagonally across slope.' },
        medium: { title: 'Landslide Alert - Medium Risk', icon: 'fas fa-layer-group', alertTitle: 'Exercise Caution', description: 'Moderate landslide risk.', riskLevel: 'MEDIUM RISK', riskColor: '#f59e0b', preparedness: ['Avoid steep slopes', 'Watch for cracks'], note: 'Be cautious after heavy rain.' },
        low: { title: 'Landslide Alert - Low Risk', icon: 'fas fa-layer-group', alertTitle: 'Stay Vigilant', description: 'Low landslide risk.', riskLevel: 'LOW RISK', riskColor: '#10b981', preparedness: ['Avoid steep cuts', 'Report instability'], note: 'Even low-risk areas can slide.' }
    }
};

const allDistricts = {
    "Bagmati": ["Kathmandu", "Bhaktapur", "Lalitpur"]
};

async function fetchWeather(city) {
    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${city},np&units=metric&appid=${WEATHER_API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.cod === 200) {
            return {
                temp: Math.round(data.main.temp),
                condition: data.weather[0].description,
                humidity: data.main.humidity,
                wind: data.wind.speed,
                feelsLike: Math.round(data.main.feels_like),
                icon: getWeatherIcon(data.weather[0].icon)
            };
        }
    } catch (e) { console.error('Weather fetch error', e); }
    return null;
}

function getWeatherIcon(iconCode) {
    const map = {
        '01d':'fa-sun','01n':'fa-moon','02d':'fa-cloud-sun','02n':'fa-cloud-moon',
        '03d':'fa-cloud','03n':'fa-cloud','04d':'fa-cloud','04n':'fa-cloud',
        '09d':'fa-cloud-rain','09n':'fa-cloud-rain','10d':'fa-cloud-sun-rain','10n':'fa-cloud-moon-rain',
        '11d':'fa-bolt','11n':'fa-bolt','13d':'fa-snowflake','13n':'fa-snowflake',
        '50d':'fa-smog','50n':'fa-smog'
    };
    return map[iconCode] || 'fa-cloud-sun';
}

async function fetchAirQuality(city) {
    try {
        const url = `https://api.airvisual.com/v2/city?city=${city}&country=Nepal&key=${AIR_QUALITY_API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.status === 'success') {
            return {
                aqi: data.data.current.pollution.aqius,
                pm25: data.data.current.pollution.pm25,
                level: getAQILevel(data.data.current.pollution.aqius)
            };
        }
    } catch (e) { console.error('Air quality fetch error', e); }
    return null;
}

function getAQILevel(aqi) {
    if (aqi <= 50) return 'Good';
    if (aqi <= 100) return 'Moderate';
    if (aqi <= 150) return 'Unhealthy for Sensitive';
    if (aqi <= 200) return 'Unhealthy';
    if (aqi <= 300) return 'Very Unhealthy';
    return 'Hazardous';
}

async function fetchEarthquakes() {
    try {
        const url = 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson';
        const res = await fetch(url);
        const data = await res.json();
        const nepalQuakes = data.features.filter(f => {
            const [lon, lat] = f.geometry.coordinates;
            return lat > 26 && lat < 31 && lon > 80 && lon < 89;
        });
        return nepalQuakes.map(q => ({
            mag: q.properties.mag,
            place: q.properties.place,
            time: new Date(q.properties.time).toLocaleString()
        }));
    } catch (e) { console.error('Earthquake fetch error', e); }
    return [];
}

async function fetchFlood(district) {
    const floodMock = {
        'kathmandu': { level: 3.2, danger: 4.5, status: 'Normal', river: 'Bagmati' },
        'bhaktapur': { level: 3.1, danger: 4.3, status: 'Normal', river: 'Bagmati' },
        'default': { level: 3.0, danger: 5.0, status: 'Normal', river: 'Local River' }
    };
    return floodMock[district.toLowerCase()] || floodMock.default;
}

async function updateWeatherUI(city) {
    const data = await fetchWeather(city);
    if (data) {
        document.getElementById('weather-temp').textContent = data.temp + '°C';
        document.getElementById('weather-condition').textContent = data.condition;
        document.getElementById('weather-humidity').textContent = data.humidity + '%';
        document.getElementById('weather-wind').textContent = data.wind + ' km/h';
        document.getElementById('weather-feels-like').textContent = data.feelsLike + '°C';
        document.getElementById('weather-icon').className = `fas ${data.icon}`;
    }
    document.getElementById('weather-update-time').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
}

async function updateAirQualityUI(city) {
    const data = await fetchAirQuality(city);
    if (data) {
        document.getElementById('air-quality-value').textContent = data.aqi;
        document.getElementById('air-quality-desc').textContent = data.level;
        document.getElementById('air-quality-pm25').textContent = data.pm25 + ' μg/m³';
        document.getElementById('air-quality-location').textContent = city;
        const pos = Math.min((data.aqi / 500) * 100, 100);
        document.getElementById('aqi-marker').style.left = pos + '%';
    } else {
        let fallbackAQI = 85;
        const lower = city.toLowerCase();
        if (['kathmandu','bhaktapur','lalitpur'].includes(lower)) fallbackAQI = 95;
        else if (['biratnagar','nepalgunj','jhapa'].includes(lower)) fallbackAQI = 110;
        else if (['pokhara','kaski'].includes(lower)) fallbackAQI = 45;
        document.getElementById('air-quality-value').textContent = fallbackAQI;
        document.getElementById('air-quality-desc').textContent = getAQILevel(fallbackAQI);
        document.getElementById('air-quality-pm25').textContent = Math.round(fallbackAQI*0.5) + ' μg/m³';
        document.getElementById('air-quality-location').textContent = city;
        const pos = Math.min((fallbackAQI / 500) * 100, 100);
        document.getElementById('aqi-marker').style.left = pos + '%';
    }
    document.getElementById('air-quality-time').textContent = new Date().toLocaleTimeString();
}

async function updateFloodUI(city) {
    const data = await fetchFlood(city);
    if (data) {
        document.getElementById('flood-level-value').textContent = data.level.toFixed(1);
        document.getElementById('flood-alert-desc').textContent = data.status;
        document.getElementById('flood-river').textContent = data.river;
        document.getElementById('flood-danger-level').textContent = data.danger + ' m';
        const percent = (data.level / data.danger) * 100;
        document.getElementById('flood-marker').style.left = Math.min(percent, 100) + '%';
    }
    document.getElementById('flood-alert-time').textContent = new Date().toLocaleTimeString();
}

function generateAlertCards() {
    const container = document.getElementById('alert-cards-container');
    container.innerHTML = '';
    const districtKey = currentDistrict.toLowerCase();
    const risks = districtRiskData[districtKey] || districtRiskData.default;
    const types = ['earthquake', 'flood', 'landslide'];
    const icons = { earthquake: 'fas fa-bolt', flood: 'fas fa-water', landslide: 'fas fa-layer-group' };
    types.forEach(type => {
        const level = risks[type] || 'medium';
        const cls = level + '-risk';
        const alertData = preparednessData[type][level];
        const card = document.createElement('div');
        card.className = `alert-card ${cls}`;
        card.innerHTML = `
            <div class="alert-header"><div class="alert-icon"><i class="${icons[type]}"></i></div><span class="alert-badge">${level.toUpperCase()} RISK</span></div>
            <h3 class="alert-title">${type.charAt(0).toUpperCase() + type.slice(1)} Alert</h3>
            <p class="alert-description">${alertData.alertTitle}</p>
            <div class="alert-actions">
                <span class="alert-click-hint"><i class="fas fa-hand-pointer"></i> Click for details</span>
                <span><i class="far fa-clock"></i> ${new Date().toLocaleTimeString()}</span>
            </div>
        `;
        card.addEventListener('click', () => showAlertDetails(alertData));
        container.appendChild(card);
    });
}

function showAlertDetails(data) {
    document.getElementById('modal-title').textContent = data.title;
    document.getElementById('modal-icon').className = data.icon;
    document.getElementById('modal-alert-title').textContent = data.alertTitle;
    document.getElementById('modal-description').textContent = data.description;
    document.getElementById('modal-note').textContent = data.note;
    const riskEl = document.getElementById('modal-risk-level');
    riskEl.textContent = data.riskLevel;
    riskEl.style.background = data.riskColor;
    riskEl.style.color = 'white';
    const list = document.getElementById('preparedness-list');
    list.innerHTML = '';
    data.preparedness.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `<i class="fas fa-check-circle"></i> ${item}`;
        list.appendChild(li);
    });
    document.getElementById('alert-modal').style.display = 'flex';
}

function populateDistrictSelect() {
    const select = document.getElementById('district-select');
    select.innerHTML = '<option value="" id="select-district">-- Select Your District --</option>';
    const demoDistricts = ['Kathmandu', 'Bhaktapur', 'Lalitpur', 'Pokhara', 'Biratnagar'];
    demoDistricts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        if (d === 'Kathmandu') opt.selected = true;
        select.appendChild(opt);
    });
}
populateDistrictSelect();

document.getElementById('get-location-btn').addEventListener('click', () => {
    const selected = document.getElementById('district-select').value;
    if (!selected) {
        document.getElementById('location-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Please select a district';
        return;
    }
    currentDistrict = selected;
    document.getElementById('location-status').innerHTML = `<i class="fas fa-map-marker-alt"></i> Alerts for: ${selected}`;
    updateWeatherUI(selected);
    updateAirQualityUI(selected);
    updateFloodUI(selected);
    generateAlertCards();
});

document.getElementById('get-my-location-btn').addEventListener('click', () => {
    document.getElementById('district-select').value = 'Kathmandu';
    currentDistrict = 'Kathmandu';
    document.getElementById('location-status').innerHTML = '<i class="fas fa-map-marker-alt"></i> Alerts for: Kathmandu';
    updateWeatherUI('Kathmandu');
    updateAirQualityUI('Kathmandu');
    updateFloodUI('Kathmandu');
    generateAlertCards();
});

document.getElementById('refresh-realtime-data').addEventListener('click', function() {
    this.classList.add('updating');
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    updateWeatherUI(currentDistrict);
    updateAirQualityUI(currentDistrict);
    updateFloodUI(currentDistrict);
    setTimeout(() => {
        this.classList.remove('updating');
        this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
    }, 1500);
});

document.getElementById('modal-close').addEventListener('click', () => {
    document.getElementById('alert-modal').style.display = 'none';
});
document.getElementById('alert-modal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('alert-modal')) {
        document.getElementById('alert-modal').style.display = 'none';
    }
});

// ========== CHATBOT ==========
const chatbotIcon = document.getElementById('chatbot-icon');
const chatbotWindow = document.getElementById('chatbot-window');
const chatbotClose = document.getElementById('chatbot-close');
const chatbotMessages = document.getElementById('chatbot-messages');
const chatbotInput = document.getElementById('chatbot-input');
const chatbotSend = document.getElementById('chatbot-send');

chatbotIcon.addEventListener('click', () => {
    chatbotWindow.style.display = 'flex';
    chatbotIcon.style.display = 'none';
});
chatbotClose.addEventListener('click', () => {
    chatbotWindow.style.display = 'none';
    chatbotIcon.style.display = 'flex';
});

function addMessage(text, sender) {
    const div = document.createElement('div');
    div.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
    div.textContent = text;
    chatbotMessages.appendChild(div);
    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
}

function extractDistrict(text) {
    const match = text.match(/in (\w+)/i);
    if (match) return match[1];
    return null;
}

async function processUserInput(input) {
    const lower = input.toLowerCase();

    if (lower.includes('weather')) {
        const district = extractDistrict(input) || currentDistrict;
        const data = await fetchWeather(district);
        if (data) addMessage(`Weather in ${district}: ${data.temp}°C, ${data.condition}, humidity ${data.humidity}%, wind ${data.wind} km/h.`, 'bot');
        else addMessage(`Could not fetch weather for ${district}.`, 'bot');
    } else if (lower.includes('air quality') || lower.includes('aqi')) {
        const district = extractDistrict(input) || currentDistrict;
        const data = await fetchAirQuality(district);
        if (data) addMessage(`Air quality in ${district}: AQI ${data.aqi} (${data.level}), PM2.5: ${data.pm25} µg/m³.`, 'bot');
        else addMessage(`Live air quality data for ${district} is not available.`, 'bot');
    } else if (lower.includes('earthquake')) {
        const quakes = await fetchEarthquakes();
        if (quakes.length > 0) {
            const recent = quakes.slice(0, 3).map(q => `${q.mag} mag at ${q.place}`).join('; ');
            addMessage(`Recent earthquakes in Nepal: ${recent}`, 'bot');
        } else {
            addMessage('No recent earthquakes detected in Nepal.', 'bot');
        }
    } else if (lower.includes('flood')) {
        const district = extractDistrict(input) || currentDistrict;
        const data = await fetchFlood(district);
        addMessage(`Flood status in ${district}: River ${data.river} at ${data.level}m (danger at ${data.danger}m). Status: ${data.status}.`, 'bot');
    } else {
        addMessage("I'm not sure about that. Try asking about weather, air quality, floods, or earthquakes.", 'bot');
    }
}

chatbotSend.addEventListener('click', () => {
    const text = chatbotInput.value.trim();
    if (!text) return;
    addMessage(text, 'user');
    chatbotInput.value = '';
    processUserInput(text);
});
chatbotInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') chatbotSend.click();
});

// ========== TAB SWITCHING ==========
function switchTab(tabId) {
    document.querySelectorAll('.floating-nav button').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId);
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === tabId);
    });
    if (tabId === 'mapping' && !map) setTimeout(initMap, 100);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.querySelectorAll('.floating-nav button').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault();
        switchTab(btn.getAttribute('data-tab'));
    });
});
document.querySelector('.discover-btn').addEventListener('click', (e) => {
    e.preventDefault();
    switchTab('mapping');
});

// ========== MAP ==========
function initMap() {
    map = L.map('interactive-map').setView([28.3949, 84.1240], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap', maxZoom: 10, minZoom: 6 }).addTo(map);
    const marker = L.marker([27.7172, 85.3240]).addTo(map)
        .bindPopup('<b>Kathmandu</b><br>Click for weather')
        .on('click', () => updateWeatherUI('Kathmandu'));
}

// ========== INITIAL LOAD ==========
updateWeatherUI('Kathmandu');
updateAirQualityUI('Kathmandu');
updateFloodUI('Kathmandu');
generateAlertCards();